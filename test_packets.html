<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Packet Capture Test</title>
    <style>
        body { font-family: monospace; background: #1a1a1a; color: #fff; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; background: #2d3748; border-radius: 8px; }
        .button { background: #00d4ff; color: #000; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .button:hover { background: #0099cc; }
        .packet { background: #1e293b; padding: 10px; margin: 5px 0; border-radius: 5px; border-left: 3px solid #00d4ff; }
        .tor-packet { border-left-color: #00ff88; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #065f46; color: #10b981; }
        .error { background: #7f1d1d; color: #f87171; }
        .warning { background: #78350f; color: #fbbf24; }
        .log { background: #000; padding: 10px; border-radius: 5px; height: 200px; overflow-y: auto; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>TOR Unveil - Packet Capture Test</h1>
        
        <div class="section">
            <h2>Backend Status</h2>
            <div id="backendStatus" class="status">Checking...</div>
            <button class="button" onclick="checkBackend()">Check Backend</button>
        </div>
        
        <div class="section">
            <h2>Packet Capture Controls</h2>
            <button class="button" onclick="startCapture()">Start Capture</button>
            <button class="button" onclick="stopCapture()">Stop Capture</button>
            <button class="button" onclick="debugSniffer()">Debug Sniffer</button>
            <button class="button" onclick="loadPackets()">Load Packets</button>
            <button class="button" onclick="clearLog()">Clear Log</button>
        </div>
        
        <div class="section">
            <h2>Debug Log</h2>
            <div id="debugLog" class="log"></div>
        </div>
        
        <div class="section">
            <h2>Live Packets (<span id="packetCount">0</span>)</h2>
            <div id="packetDisplay"></div>
        </div>
    </div>

    <script>
        let logDiv = document.getElementById('debugLog');
        let packetDiv = document.getElementById('packetDisplay');
        let packetCountSpan = document.getElementById('packetCount');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#00d4ff',
                success: '#00ff88',
                error: '#ff4444',
                warning: '#ffaa00'
            };
            logDiv.innerHTML += `<div style="color: ${colors[type]}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            logDiv.innerHTML = '';
        }
        
        async function checkBackend() {
            try {
                const response = await fetch('http://localhost:5000/api/health');
                const data = await response.json();
                
                document.getElementById('backendStatus').innerHTML = `
                    <div class="success">✓ Backend Online</div>
                    <div>Scapy Available: ${data.sniffer_available ? '✓' : '✗'}</div>
                    <div>Admin Required: ${data.admin_required ? '✓' : '✗'}</div>
                    <div>TOR Connected: ${data.tor_connected ? '✓' : '✗'}</div>
                `;
                log('Backend health check successful', 'success');
            } catch (error) {
                document.getElementById('backendStatus').innerHTML = `<div class="error">✗ Backend Offline</div>`;
                log(`Backend check failed: ${error.message}`, 'error');
            }
        }
        
        async function startCapture() {
            try {
                log('Starting packet capture...', 'info');
                const response = await fetch('http://localhost:5000/api/capture/start', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.status === 'started') {
                    log('✓ Packet capture started successfully', 'success');
                } else {
                    log(`✗ Failed to start capture: ${data.message}`, 'error');
                }
            } catch (error) {
                log(`Start capture error: ${error.message}`, 'error');
            }
        }
        
        async function stopCapture() {
            try {
                log('Stopping packet capture...', 'info');
                const response = await fetch('http://localhost:5000/api/capture/stop', {
                    method: 'POST'
                });
                const data = await response.json();
                log(`✓ Capture stopped: ${data.message}`, 'success');
            } catch (error) {
                log(`Stop capture error: ${error.message}`, 'error');
            }
        }
        
        async function debugSniffer() {
            try {
                const response = await fetch('http://localhost:5000/api/debug/sniffer');
                const data = await response.json();
                
                log(`Debug Info:`, 'info');
                log(`  - Active: ${data.sniffer_active}`, 'info');
                log(`  - Total Packets: ${data.total_packets}`, 'info');
                log(`  - TOR Packets: ${data.tor_packets}`, 'info');
                log(`  - Interface: ${data.interface || 'default'}`, 'info');
                log(`  - Scapy Available: ${data.scapy_available}`, 'info');
                
                if (data.last_5_packets && data.last_5_packets.length > 0) {
                    log(`  - Last packet: ${data.last_5_packets[data.last_5_packets.length - 1].src_ip} → ${data.last_5_packets[data.last_5_packets.length - 1].dst_ip}`, 'info');
                }
            } catch (error) {
                log(`Debug error: ${error.message}`, 'error');
            }
        }
        
        async function loadPackets() {
            try {
                log('Loading packets...', 'info');
                const response = await fetch('http://localhost:5000/api/capture/packets');
                const data = await response.json();
                
                log(`Received data type: ${Array.isArray(data) ? 'array' : typeof data}`, 'info');
                
                if (Array.isArray(data)) {
                    log(`✓ Loaded ${data.length} packets`, 'success');
                    displayPackets(data);
                } else if (data && data.packets) {
                    log(`✓ Loaded ${data.packets.length} packets (wrapped)`, 'success');
                    displayPackets(data.packets);
                } else {
                    log('✗ No packets found in response', 'warning');
                    log(`Response: ${JSON.stringify(data).substring(0, 200)}`, 'info');
                }
            } catch (error) {
                log(`Load packets error: ${error.message}`, 'error');
            }
        }
        
        function displayPackets(packets) {
            packetCountSpan.textContent = packets.length;
            packetDiv.innerHTML = '';
            
            if (packets.length === 0) {
                packetDiv.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">No packets to display</div>';
                return;
            }
            
            // Show last 10 packets
            const recentPackets = packets.slice(-10).reverse();
            
            recentPackets.forEach((packet, index) => {
                const packetEl = document.createElement('div');
                packetEl.className = `packet ${packet.is_tor ? 'tor-packet' : ''}`;
                
                const protocol = (packet.protocols && packet.protocols.length > 0) ? 
                    packet.protocols[packet.protocols.length - 1] : 
                    (packet.protocol || 'Unknown');
                
                const srcPort = packet.src_port ? `:${packet.src_port}` : '';
                const dstPort = packet.dst_port ? `:${packet.dst_port}` : '';
                const time = packet.timestamp ? new Date(packet.timestamp).toLocaleTimeString() : 'Unknown';
                
                packetEl.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: bold; color: ${packet.is_tor ? '#00ff88' : '#00d4ff'};">
                                ${protocol} ${packet.is_tor ? '(TOR)' : ''}
                            </div>
                            <div style="font-size: 12px; color: #ccc;">
                                ${packet.src_ip || 'Unknown'}${srcPort} → ${packet.dst_ip || 'Unknown'}${dstPort}
                            </div>
                            ${packet.info ? `<div style="font-size: 11px; color: #ffaa00;">${packet.info}</div>` : ''}
                        </div>
                        <div style="font-size: 11px; color: #888;">
                            ${packet.length || packet.size || 0}B | ${time}
                        </div>
                    </div>
                `;
                
                packetDiv.appendChild(packetEl);
            });
        }
        
        // Auto-refresh packets every 2 seconds
        setInterval(loadPackets, 2000);
        
        // Initial checks
        checkBackend();
        loadPackets();
    </script>
</body>
</html>