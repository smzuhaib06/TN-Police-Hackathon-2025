<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ summary }}</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f7f7fa; color: #222; margin: 0; }
    .container { max-width: 1100px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px #0002; padding: 32px; }
    h1, h2 { color: #2a3a5e; }
    .section { margin-bottom: 32px; }
    .summary { font-size: 1.2em; margin-bottom: 16px; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 24px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background: #e3e8f0; }
    .confidence-high { color: #1aaf5d; font-weight: bold; }
    .confidence-med { color: #f7b731; font-weight: bold; }
    .confidence-low { color: #eb3b5a; font-weight: bold; }
    .alert-critical { color: #eb3b5a; font-weight: bold; }
    .alert-warning { color: #f7b731; font-weight: bold; }
    .alert-info { color: #2a3a5e; font-weight: bold; }
    .btn { background: #2a3a5e; color: #fff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-right: 8px; }
    .btn:hover { background: #1aaf5d; }
    #charts { display: flex; gap: 32px; flex-wrap: wrap; }
    .chart-box { flex: 1 1 400px; min-width: 350px; height: 320px; background: #f7f7fa; border-radius: 8px; box-shadow: 0 1px 6px #0001; margin-bottom: 24px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>{{ summary }}</h1>
    <div class="summary section">{{ details }}</div>
    <div class="section">
              <h2>Alerts & Anomalies</h2>
              {% if alerts and alerts|length > 0 %}
              <ul>
                {% for alert in alerts %}
                  {% if alert.level == 'critical' %}
                    <li class="alert-critical">[{{ alert.level|capitalize }}] {{ alert.msg }}</li>
                  {% elif alert.level == 'warning' %}
                    <li class="alert-warning">[{{ alert.level|capitalize }}] {{ alert.msg }}</li>
                  {% else %}
                    <li class="alert-info">[{{ alert.level|capitalize }}] {{ alert.msg }}</li>
                  {% endif %}
                {% endfor %}
              </ul>
                  {% else %}
                  <p>No alerts or anomalies detected.</p>
                  {% endif %}
              <h2>Correlated PCAP Flows</h2>
          {% if correlated and correlated|length > 0 %}
          <table>
            <tr><th>Timestamp</th><th>Protocol</th><th>Source</th><th>Destination</th><th>Circuit ID</th><th>Relay Nickname</th><th>Relay Fingerprint</th></tr>
            {% for match in correlated %}
            <tr>
              <td>{{ match.flow.ts }}</td>
              <td>{{ match.flow.proto }}</td>
              <td>{{ match.flow.src }}</td>
              <td>{{ match.flow.dst }}</td>
              <td>{{ match.circuit_id }}</td>
              <td>{{ match.relay_nickname }}</td>
              <td>{{ match.relay_fingerprint }}</td>
            </tr>
            {% endfor %}
          </table>
          {% else %}
          <p>No correlated PCAP flows found.</p>
          {% endif %}
      <button class="btn" onclick="window.print()">Print Report</button>
      <button class="btn" onclick="downloadReport()">Download HTML</button>
    </div>
    <div class="section">
      <h2>Key Findings</h2>
      <ul>
        <li><b>Circuits analyzed:</b> {{ circuits|length }}</li>
        <li><b>Relays loaded:</b> {{ relays|length }}</li>
        <li><b>Entry/Exit correlations:</b> {{ correlations|length if correlations else 0 }}</li>
      </ul>
    </div>
    <div class="section" id="charts">
            <div id="bandwidthChart" class="chart-box"></div>
            <div id="latencyChart" class="chart-box"></div>
          {% set relay_points = [] %}
          {% for r in relays %}
            {% if r.lat and r.lon %}
              {% set _ = relay_points.append({'name': r.n, 'value': [r.lon, r.lat], 'country': r.c}) %}
            {% endif %}
          {% endfor %}
      <div id="networkChart" class="chart-box"></div>
      <div id="confidenceChart" class="chart-box"></div>
      <div id="timelineChart" class="chart-box"></div>
      <div id="geoMapChart" class="chart-box"></div>
    </div>
    {% set network_nodes = [] %}
    {% set network_links = [] %}
    {% for c in circuits %}
      {% for hop in c.path %}
        {% set _ = network_nodes.append({'name': hop.nickname, 'value': hop.fingerprint}) %}
      {% endfor %}
      {% for i in range(c.path|length - 1) %}
        {% set _ = network_links.append({'source': c.path[i].nickname, 'target': c.path[i+1].nickname}) %}
      {% endfor %}
    {% endfor %}
    {% set corr_data = [] %}
    {% for corr in correlations %}
      {% set _ = corr_data.append({'name': corr.entry, 'value': corr.confidence}) %}
    {% endfor %}
    {% set timeline_data = [] %}
    {% for c in circuits %}
      {% set _ = timeline_data.append({'name': c.id, 'value': loop.index * 10}) %}
    {% endfor %}
    </div>
    <div class="section">
      <h2>Entry/Exit Node Correlations</h2>
      <table>
        <tr><th>Exit Fingerprint</th><th>Entry Candidate</th><th>Confidence</th></tr>
        {% for corr in correlations %}
        <tr>
          <td>{{ corr.exit }}</td>
          <td>{{ corr.entry }}</td>
          <td class="{{ 'confidence-high' if corr.confidence >= 0.8 else 'confidence-med' if corr.confidence >= 0.5 else 'confidence-low' }}">{{ '%.2f'|format(corr.confidence) }}</td>
        </tr>
        {% endfor %}
      </table>
    </div>
    <div class="section">
      <h2>Circuits</h2>
      <table>
        <tr><th>ID</th><th>Path</th></tr>
        {% for c in circuits %}
        <tr>
          <td>{{ c.id }}</td>
          <td>
            {% for hop in c.path %}
              <span style="margin-right:8px;">{{ hop.nickname }} <small>({{ hop.fingerprint }})</small></span>
            {% endfor %}
          </td>
        </tr>
        {% endfor %}
      </table>
    </div>
    <div class="section">
      <h2>Relays</h2>
      <table>
        <tr><th>Nickname</th><th>IP</th><th>Country</th><th>Bandwidth</th></tr>
        {% for r in relays[:20] %}
        <tr>
          <td>{{ r.n }}</td>
          <td>{{ r.a }}</td>
          <td>{{ r.c }}</td>
          <td>{{ r.bw }}</td>
        </tr>
        {% endfor %}
      </table>
      <small>Showing first 20 relays.</small>
    </div>
    <div class="section">
      <h2>Timeline of Activity</h2>
      <div id="timelineChart" class="chart-box"></div>
    </div>
    <div class="section">
      <h2>Recommendations</h2>
      <ul>
        <li>Review high-confidence entry/exit pairs for further investigation.</li>
        <li>Correlate PCAP logs for additional evidence.</li>
        <li>Repeat analysis with new data for improved accuracy.</li>
      </ul>
    </div>
  </div>
  <script>
            // Bandwidth Chart
            var bandwidths = JSON.parse(`{{ bandwidth_latency.bandwidths|tojson|safe }}`);
            var bandwidthChart = echarts.init(document.getElementById('bandwidthChart'));
            bandwidthChart.setOption({
              title: { text: 'Relay Bandwidths', left: 'center' },
              xAxis: { type: 'category', data: bandwidths.map((_, i) => 'Relay ' + (i+1)) },
              yAxis: { type: 'value', min: 0 },
              series: [{ type: 'bar', data: bandwidths, itemStyle: { color: '#2a3a5e' } }]
            });
            // Latency Chart
            var latencies = JSON.parse(`{{ bandwidth_latency.latencies|tojson|safe }}`);
            var latencyChart = echarts.init(document.getElementById('latencyChart'));
            latencyChart.setOption({
              title: { text: 'Circuit Latencies', left: 'center' },
              xAxis: { type: 'category', data: latencies.map((_, i) => 'Circuit ' + (i+1)) },
              yAxis: { type: 'value', min: 0 },
              series: [{ type: 'line', data: latencies, smooth: true, itemStyle: { color: '#f7b731' } }]
            });
        // GeoIP Map Chart
        var geoMapChart = echarts.init(document.getElementById('geoMapChart'));
        var relayPoints = JSON.parse(`{{ relay_points|tojson|safe }}`);
        geoMapChart.setOption({
          title: { text: 'Relay GeoIP Map', left: 'center' },
          tooltip: { trigger: 'item', formatter: function(params) { return params.name + '<br>' + params.data.country; } },
          geo: {
            map: 'world',
            roam: true,
            itemStyle: { areaColor: '#e3e8f0', borderColor: '#888' },
          },
          series: [{
            type: 'scatter',
            coordinateSystem: 'geo',
            data: relayPoints,
            symbolSize: 10,
            itemStyle: { color: '#1aaf5d' }
          }]
        });
    // Removed duplicate and invalid code
    // End of chart setup
    // Network Graph
    var networkChart = echarts.init(document.getElementById('networkChart'));
    var nodes = JSON.parse(`{{ network_nodes|tojson|safe }}`);
    var links = JSON.parse(`{{ network_links|tojson|safe }}`);
    networkChart.setOption({
      title: { text: 'Circuit Network Map', left: 'center' },
      tooltip: {},
      series: [{
        type: 'graph',
        layout: 'circular',
        data: nodes,
        links: links,
        roam: true,
        label: { show: true },
        lineStyle: { color: '#888' }
      }]
    });
    // Confidence Chart
    var confidenceChart = echarts.init(document.getElementById('confidenceChart'));
    var corrData = JSON.parse(`{{ corr_data|tojson|safe }}`);
    confidenceChart.setOption({
      title: { text: 'Entry Node Confidence', left: 'center' },
      xAxis: { type: 'category', data: corrData.map(d => d.name) },
      yAxis: { type: 'value', min: 0, max: 1 },
      series: [{ type: 'bar', data: corrData.map(d => d.value), itemStyle: { color: '#1aaf5d' } }]
    });
    // Timeline Chart
    var timelineChart = echarts.init(document.getElementById('timelineChart'));
    var timelineData = JSON.parse(`{{ timeline_data|tojson|safe }}`);
    timelineChart.setOption({
      title: { text: 'Circuit Activity Timeline', left: 'center' },
      xAxis: { type: 'category', data: timelineData.map(d => d.name) },
      yAxis: { type: 'value' },
      series: [{ type: 'line', data: timelineData.map(d => d.value), smooth: true, itemStyle: { color: '#2a3a5e' } }]
    });
  </script>
</body>
</html>
